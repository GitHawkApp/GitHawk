#!/usr/bin/env groovy

pipeline {
    agent {
        node {
            label 'MacOSX'
        }
    }
    environment {
        LC_ALL = "en_US.UTF-8"
        LANG = "en_US.UTF-8"
        LANGUAGE = "en_US.UTF-8"
        GYM_OUTPUT_DIRECTORY = "artifacts"
    }
    stages {
        stage('Setup project') {
            steps {
                catchError {
                    sh "bundle"
                    sh "bundle exec pod install"
                    sh "npm install"  
                }      
            }
        }
        stage('Build and deploy Application') {
            steps {
                catchError {
                    withCredentials([string(credentialsId: "${MAC_PASSWORD}", variable: 'mac_password')]) {
                        sh "security unlock-keychain -p ${mac_password} login.keychain-db"
                    }
                    script {
                        if (env.BRANCH_NAME == 'master') {
                            sh 'fastlane publish'
                        } else {
                            withCredentials([string(credentialsId: 'crashlytics_api_token', 
                                                    variable: 'CRASHLYTICS_API_TOKEN'),
                                             string(credentialsId: 'crashlytics_build_secret', 
                                                    variable: 'CRASHLYTICS_BUILD_SECRET'),
                                             string(credentialsId: 'github_match_password', 
                                                    variable: 'MATCH_PASSWORD')]) {
                                sh "fastlane beta"
                            }
                        }
                    }
                }
            }
        }
    }
    post('Archive necessary artifact') {
        always {
            archiveArtifacts artifacts: "${env.GYM_OUTPUT_DIRECTORY}/", onlyIfSuccessful: true
        }
    }
}
