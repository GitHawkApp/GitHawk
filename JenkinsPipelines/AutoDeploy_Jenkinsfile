#!/usr/bin/env groovy

pipeline {
    agent {
        node {
            label 'MacOSX'
        }
    }
    environment {
        GYM_DESTINATION = "artifacts"
    }
    stages {
        stage('Setup project') {
            steps {
                catchError {
                    sh "bundle"
                    sh "bundle exec pod install"
                    sh "npm install"  
                }      
            }
        }
        stage('Build and/or deploy Application') {
            steps {
                catchError {
                    withCredentials([string(credentialsId: 'thanh_mac_password', variable: 'mac_password')]) {
                        sh "security unlock-keychain -p ${mac_password} login.keychain-db"
                    }
                    script {
                        if (env.BRANCH_NAME == 'master') {
                            echo 'fastlane appstore'
                        } else {
                            withCredentials([string(credentialsId: 'crashlytics_api_token', 
                                                    variable: 'CRASHLYTICS_API_TOKEN'),
                                             string(credentialsId: 'crashlytics_build_secret', 
                                                    variable: 'CRASHLYTICS_BUILD_SECRET')]) {
                                sh "fastlane beta"
                            }
                        }
                    }
                }
            }
        }
    }
    post('Archive necessary artifact') {
        always {
            archiveArtifacts artifacts: "${env.GYM_DESTINATION}/", onlyIfSuccessful: true
        }
    }
}
